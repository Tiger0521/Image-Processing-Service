
## ğŸ“ é˜¶æ®µäºŒç›®å½•ç»“æ„è¡¥å……ï¼ˆåŸºäºä½ å·²æœ‰çš„é˜¶æ®µä¸€ç»“æ„ï¼‰

```
project/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                 # FastAPI å¯åŠ¨å…¥å£
â”‚   â”œâ”€â”€ models.py               # æ•°æ®æ¨¡å‹ï¼ˆæ–°å¢ Image æ¨¡å‹ï¼‰
â”‚   â”œâ”€â”€ auth.py                 # JWT & å¯†ç å¤„ç†
â”‚   â”œâ”€â”€ database.py             # æ•°æ®åº“è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ schemas.py              # è¯·æ±‚/å“åº”çš„ Pydantic schema
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ user_routes.py      # æ³¨å†Œ/ç™»å½•è·¯ç”±
â”‚   â”‚   â””â”€â”€ image_routes.py     # ä¸Šä¼ /è·å–/åˆ—å‡ºå›¾åƒè·¯ç”±ï¼ˆé˜¶æ®µäºŒæ–°å¢ï¼‰
â”‚
â”œâ”€â”€ static/
â”‚   â””â”€â”€ uploads/                # æœ¬åœ°å­˜å‚¨å›¾ç‰‡æ–‡ä»¶å¤¹ï¼ˆFastAPI é™æ€æ‰˜ç®¡ï¼‰
â”œâ”€â”€ requirements.txt
```

---

## âœ… é˜¶æ®µäºŒå®Œæ•´å®ç°æ­¥éª¤

---

### ğŸ”¹ ç¬¬ä¸€æ­¥ï¼šæ›´æ–° `models.py`ï¼Œæ·»åŠ  Image æ¨¡å‹

```python
# app/models.py
from sqlalchemy import Column, Integer, String, ForeignKey, DateTime
from sqlalchemy.orm import relationship
from datetime import datetime
from .database import Base

'''
åˆ›å»ºimageæ¨¡å‹ç±»ï¼Œå¯¹åº”æ•°æ®åº“ä¸­çš„imageè¡¨
'''  
class Image(Base):
    __tablename__ = 'images' # è¡¨å

    # ä¸»é”®å­—æ®µï¼Œè‡ªåŠ¨é€’å¢
    id = Column(Integer, primary_key=True, index=True)  # å½“åˆ›å»ºè¡¨æ—¶ï¼ŒSQLAlchemyä¼šè‡ªåŠ¨ç”Ÿæˆä¸»é”®å€¼ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦ï¼ˆä¹Ÿä¸åº”è¯¥ï¼‰æ‰‹åŠ¨æŒ‡å®š

    # å›¾ç‰‡æ–‡ä»¶å
    filename = Column(String, unique=True, index=True, nullable=False) # unique=Trueè¡¨ç¤ºæ•°æ®åº“è¡¨ä¸­ä¸å…è®¸æœ‰é‡å¤çš„æ–‡ä»¶å

    # å›¾ç‰‡è®¿é—®URL
    url = Column(String, unique=True, index=True, nullable=False) # unique=Trueè¡¨ç¤º

    # å›¾ç‰‡ç±»å‹
    content_type = Column(String) # æ–‡ä»¶ç±»å‹ï¼Œä¾‹å¦‚'image/jpeg'

    # å›¾ç‰‡å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰
    size = Column(Integer) # æ–‡ä»¶å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½
    width = Column(Integer) # å›¾ç‰‡å®½åº¦
    height = Column(Integer) # å›¾ç‰‡é«˜åº¦

    # å›¾ç‰‡ä¸Šä¼ æ—¶é—´
    uploaded_at = Column(DateTime, default=datetime.utcnow()) # é»˜è®¤å€¼ä¸ºå½“å‰UTCæ—¶é—´

    # å›¾ç‰‡æ‰€å±ç”¨æˆ·
    user_id = Column(Integer, ForeignKey('users.id')) # å¤–é”®ï¼Œå…³è”åˆ°Userè¡¨çš„idå­—æ®µ
```

---

### ğŸ”¹ ç¬¬äºŒæ­¥ï¼šæ›´æ–° `schemas.py`

```python
# app/schemas.py
from pydantic import BaseModel
from typing import Optional
from datetime import datetime

'''
ImageOutæ¨¡å‹:
è¡¨ç¤ºå¯¹å¤–æ¥å£è¿”å›çš„å›¾åƒä¿¡æ¯ç»“æ„,
å‘Šè¯‰è°ƒç”¨è€…ï¼šå›¾åƒæœ‰å“ªäº›å­—æ®µï¼ˆIDã€æ–‡ä»¶åã€URLã€å¤§å°ã€å®½é«˜ç­‰ï¼‰ã€‚
'''
class ImageOut(BaseModel):
    id: int         # å›¾ç‰‡ID
    filename: str   # å›¾ç‰‡æ–‡ä»¶å
    url: str        # å›¾ç‰‡URL
    content_type: Optional[str]   # æ–‡ä»¶ç±»å‹ï¼Œå¯é€‰å­—æ®µï¼Œæ¯”å¦‚'image/jpeg'
    size: Optional[int]            # æ–‡ä»¶å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œå¯é€‰å­—æ®µ
    width: Optional[int]           # å›¾ç‰‡å®½åº¦ï¼Œå¯é€‰å­—æ®µ
    height: Optional[int]          # å›¾ç‰‡é«˜åº¦ï¼Œå¯é€‰å­—æ®µ
    uploaded_at: datetime          # ä¸Šä¼ æ—¶é—´ï¼Œæ ¼å¼ä¸º ISO 8601 å­—ç¬¦ä¸²

    class Config:
        from_attributes = True  # å¼€å¯ ORM æ¨¡å¼ï¼Œå¯ä»¥ç›´æ¥æ˜ å°„åˆ°æ•°æ®åº“è¡¨å­—æ®µ
```

---

### ğŸ”¹ ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º `image_routes.py`

```python
# app/routes/image_routes.py
from fastapi import APIRouter, File, UploadFile, Depends, HTTPException
from sqlalchemy.orm import Session
from app.database import get_db
from app.auth import get_current_user
from app.models import Image
from app.schemas import ImageOut
from PIL import Image as PILImage
import os, uuid, shutil
from typing import List

router = APIRouter(
    prefix="",
    tags=["Images"]  # å¦‚æœæ²¡æŒ‡å®š tagsï¼Œä¼šå½±å“ Swagger UI åˆ†ç±»è¯†åˆ«
)


# ä¸Šä¼ å›¾åƒçš„æœ¬åœ°å­˜å‚¨ç›®å½•ï¼Œç¡®ä¿ç›®å½•åˆæ³•
UPLOAD_DIR = "static/uploads"
os.makedirs(UPLOAD_DIR, exist_ok=True)  # å¦‚æœç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º


'''
ä¸Šä¼ å›¾åƒçš„è·¯ç”±å¤„ç†å‡½æ•°
'''
@router.post("/images", response_model=ImageOut)
def upload_image(
    file: UploadFile = File(...),  # æ¥æ”¶ä¸Šä¼ çš„æ–‡ä»¶
    db: Session = Depends(get_db),  # è·å–æ•°æ®åº“ä¼šè¯
    current_user: User = Depends(get_current_user)  # è·å–å½“å‰ç”¨æˆ·
):
    # 1. æ ¡éªŒæ–‡ä»¶MIMEç±»å‹æ˜¯å¦æ˜¯å›¾ç‰‡
    if not file.content_type.startswith('image/'):
        raise HTTPException(status_code=400, detail="Invalid image file type")


    # 2. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å= UUID_åŸå§‹æ–‡ä»¶å
    file_name = f"{uuidlib.uuid4().hex}_{file.filename}" # uuid4().hex æ˜¯ä¸€ä¸ªå±æ€§ï¼Œä¸æ˜¯æ–¹æ³•,hexåé¢ä¸éœ€è¦æ‹¬å·
    file_path = os.path.join(UPLOAD_DIR, file_name)  # æ„é€ æ–‡ä»¶è·¯å¾„


    # 3. å°†ä¸Šä¼ æ–‡ä»¶æµå†™å…¥æœ¬åœ°æ–‡ä»¶
    with open(file_path, "wb") as buffer:
        shutil.copyfileobj(file.file, buffer)  # file.file æ˜¯æ–‡ä»¶çš„åº•å±‚äºŒè¿›åˆ¶æµå¯¹è±¡ï¼ŒåŒ…å«ä¸Šä¼ æ–‡ä»¶çš„å®é™…å†…å®¹


    # 4. ä½¿ç”¨PILåº“æ‰“å¼€å›¾åƒæ–‡ä»¶ï¼Œè·å–å›¾åƒå°ºå¯¸ã€æ ¼å¼ç­‰ä¿¡æ¯
    try:
        with PILImage.open(file_path) as img:
            width, height = img.size  # è·å–å›¾åƒå®½åº¦å’Œé«˜åº¦
    except Exception :
        os.remove(file_path)  # åˆ é™¤æœ¬åœ°æ–‡ä»¶
        raise HTTPException(status_code=400, detail="Invalid image file")


    # 5. è·å–æ–‡ä»¶å¤§å°
    file_size = os.path.getsize(file_path)


    # 6. åˆ›å»º Image ORM å¯¹è±¡ï¼Œå¹¶ä¿å­˜åˆ°æ•°æ®åº“
    image = Image(
        filename=file_name,
        url=file_path,
        content_type=file.content_type,
        size=file_size,
        width=width,
        height=height,
        user_id=current_user.id,
    )


    # 7. æ·»åŠ ã€æäº¤å¹¶åˆ·æ–°æ•°æ®åº“å¯¹è±¡
    db.add(image)
    db.commit()
    db.refresh(image)


    # 8. è¿”å›æ•°æ®åº“ä¿å­˜åçš„å›¾åƒä¿¡æ¯ï¼Œä¾›å‰ç«¯æ˜¾ç¤ºæˆ–åç»­æ“ä½œ
    return image



'''
è¿”å›å½“å‰ç™»å½•ç”¨æˆ·ä¸Šä¼ çš„æ‰€æœ‰å›¾ç‰‡ä¿¡æ¯ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
'''
@router.get("/images", response_model=List[ImageOut])
def list_images(
    page: int = 1,  # é¡µç 
    size: int = 10,  # æ¯é¡µæ•°é‡
    db: Session = Depends(get_db),  # è·å–æ•°æ®åº“ä¼šè¯
    current_user: User = Depends(get_current_user)  # è·å–å½“å‰ç”¨æˆ·
):  
    # è®¡ç®—åˆ†é¡µåç§»é‡
    offset = (page - 1) * size

    # æŸ¥è¯¢å½“å‰ç”¨æˆ·ä¸Šä¼ çš„æ‰€æœ‰å›¾ç‰‡ï¼ŒæŒ‰ä¸Šä¼ æ—¶é—´é™åºæ’åˆ—
    images = db.query(Image)\
        .filter_by(user_id == current_user.id)\
                .offset(offset).limit(size).all()

    # è¿”å›æŸ¥è¯¢ç»“æœ
    return images



'''
æ ¹æ®å›¾ç‰‡ ID è·å–è¯¥å›¾ç‰‡è¯¦ç»†ä¿¡æ¯çš„æ¥å£ï¼Œ
'''
@router.get("/images/{image_id}", response_model=ImageOut)
def get_image(
    image_id: int,  # å›¾ç‰‡ID
    db: Session = Depends(get_db),  # è·å–æ•°æ®åº“ä¼šè¯
    current_user: User = Depends(get_current_user)  # è·å–å½“å‰ç”¨æˆ·
):
    # æŸ¥è¯¢å›¾ç‰‡ä¿¡æ¯
    image = db.query(Image).filter_by(id=image_id, user_id=current_user.id).first()

    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡ï¼ŒæŠ›å‡º404é”™è¯¯
    if not image:
        raise HTTPException(status_code=404, detail="Image not found")

    # è¿”å›æŸ¥è¯¢ç»“æœ
    return image
```

---

### ğŸ”¹ ç¬¬å››æ­¥ï¼šåœ¨ `main.py` æ³¨å†Œæ–°è·¯ç”±å’Œé™æ€æ–‡ä»¶

```python
# app/main.py
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from app.routes import user_routes, image_routes
from app.database import Base, engine

Base.metadata.create_all(bind=engine)

app = FastAPI()

app.mount("/static", StaticFiles(directory="static"), name="static")

app.include_router(user_routes.router)
app.include_router(image_routes.router)
```

---
### ğŸ”¹ ç¬¬äº”æ­¥ï¼šè¿›è¡ŒOpenAPI å®‰å…¨å®šä¹‰
```python
# âœ… æ·»åŠ è‡ªå®šä¹‰ OpenAPI å®‰å…¨å®šä¹‰ï¼ˆç¡®ä¿ Swagger UI å‡ºç° token è¾“å…¥æ¡†ï¼‰
def custom_openapi():
    if app.openapi_schema:
        return app.openapi_schema

    openapi_schema = get_openapi(
        title="Your Image API",
        version="1.0.0",
        description="Cloudinary-like image API",
        routes=app.routes,
    )

    openapi_schema["components"]["securitySchemes"] = {
        "BearerAuth": {
            "type": "http",
            "scheme": "bearer",
            "bearerFormat": "JWT"
        }
    }

    # âœ… æ˜ç¡®æ ‡æ³¨å“ªäº›è·¯å¾„å’Œæ–¹æ³•éœ€è¦è®¤è¯ï¼ˆä½ ä¹Ÿå¯ä»¥ç”¨æ­£åˆ™åŒ¹é…ï¼‰
    protected_routes = {
        "/images": ["post", "get"],
        "/images/{image_id}": ["get"],
        "/test-token": ["get"]
    }

    for path, methods in protected_routes.items():
        if path in openapi_schema["paths"]:
            for method in methods:
                method_obj = openapi_schema["paths"][path].get(method)
                if method_obj:
                    method_obj["security"] = [{"BearerAuth": []}]  # âœ… åŠ å®‰å…¨æ ‡å¿—

    app.openapi_schema = openapi_schema
    return app.openapi_schema


app.openapi = custom_openapi
```
### ğŸ”¹ ç¬¬å…­æ­¥ï¼šæµ‹è¯•ä¸Šä¼ ä¸è·å–

1.ç»ˆç«¯è¾“å…¥å‘½ä»¤å¼€å¯æœåŠ¡ï¼š
```cmd
uvicorn app.main:app --reload
```
2. è¿›å…¥ç½‘å€http://127.0.0.1:8000/docs
3. ç‚¹å‡»POST /login ï¼Œç‚¹å‡»æŒ‰é’®try it outï¼Œç™»å½•ç”¨æˆ·ï¼Œç‚¹å‡»æŒ‰é’®Executeï¼Œå¤åˆ¶ç»™åˆ°çš„"access_token"
4. ç‚¹å‡»ä¸Šé¢çš„å¤§æŒ‰é’®Authorize,è¾“å…¥æ‰€å¤åˆ¶çš„"access_token"ï¼Œç‚¹å‡»æŒ‰é’®Authorize
5. ç‚¹å‡»POST /images,ç‚¹å‡»æŒ‰é’®try it out,ä¸Šä¼ å›¾ç‰‡ï¼Œç‚¹å‡»æŒ‰é’®Execute
---

