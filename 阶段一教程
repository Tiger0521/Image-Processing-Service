 **é˜¶æ®µä¸€ï¼šç”¨æˆ·ç³»ç»Ÿ + JWT èº«ä»½éªŒè¯ + æ•°æ®åº“æ¨¡å‹æ­å»º**ã€‚

æˆ‘å°†ä»¥ **Python + FastAPI + SQLAlchemy + SQLiteï¼ˆå¼€å‘æœŸï¼‰** ä¸ºä¾‹è¿›è¡Œç¤ºèŒƒï¼Œä½ å¯ä»¥ç¨åæ›¿æ¢ä¸º PostgreSQL æˆ–å…¶ä»–æ•°æ®åº“ã€‚

---

## âœ… é˜¶æ®µä¸€ç›®æ ‡ï¼š

* åˆå§‹åŒ– FastAPI é¡¹ç›®
* æ­å»º SQLite æ•°æ®åº“
* å®ç°æ³¨å†Œ `/register` å’Œç™»å½• `/login` æ¥å£
* å®ç° JWT ç”Ÿæˆä¸éªŒè¯æœºåˆ¶
* ç”¨æˆ·æ•°æ®å®‰å…¨å­˜å‚¨ï¼ˆå¯†ç å“ˆå¸Œï¼‰

---

## ğŸ“ ç›®å½•ç»“æ„

```
project/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py               # FastAPI å¯åŠ¨å…¥å£
â”‚   â”œâ”€â”€ models.py             # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ auth.py               # JWT & å¯†ç å¤„ç†
â”‚   â”œâ”€â”€ database.py           # æ•°æ®åº“è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ schemas.py            # è¯·æ±‚å’Œå“åº”çš„æ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ user_routes.py    # æ³¨å†Œ/ç™»å½•è·¯ç”±
â”œâ”€â”€ requirements.txt
```

---

## 1ï¸âƒ£ åˆå§‹åŒ–é¡¹ç›®ä¸ä¾èµ–

```bash
mkdir image-service && cd image-service
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install fastapi uvicorn[standard] sqlalchemy passlib[bcrypt] python-jose
```

### `requirements.txt`

```
fastapi
uvicorn[standard]
sqlalchemy
passlib[bcrypt]
python-jose
```

---

## 2ï¸âƒ£ æ•°æ®åº“è¿æ¥ä¸æ¨¡å‹

### `app/database.py`

```python
from sqlalchemy import create_engine  # åˆ›å»ºæ•°æ®åº“å¼•æ“ï¼ˆè´Ÿè´£è¿æ¥æ•°æ®åº“ï¼‰
from sqlalchemy.ext.declarative import declarative_base  # åˆ›å»ºæ¨¡å‹åŸºç±»
from sqlalchemy.orm import sessionmaker  # åˆ›å»ºæ•°æ®åº“ä¼šè¯ï¼ˆç”¨äºæ‰§è¡Œ CRUD æ“ä½œï¼‰

# ä½¿ç”¨ SQLite æ•°æ®åº“ï¼ˆæœ¬åœ°å¼€å‘æœŸä½¿ç”¨æ–‡ä»¶æ•°æ®åº“ï¼Œé€‚åˆå¿«é€Ÿè°ƒè¯•ï¼‰
# è‹¥ä½¿ç”¨ PostgreSQLï¼Œè¯·æ”¹ä¸ºï¼špostgresql://user:password@localhost/dbname
SQLALCHEMY_DATABASE_URL = "sqlite:///./images.db"

# åˆ›å»ºæ•°æ®åº“å¼•æ“
# connect_args={"check_same_thread": False} æ˜¯ SQLite ç‰¹æœ‰çš„è®¾ç½®
engine = create_engine(
    SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread": False}
)

# åˆ›å»ºæ•°æ®åº“ä¼šè¯å·¥å‚
# æ¯æ¬¡è¯·æ±‚æ•°æ®åº“æ—¶å¯ä»¥è°ƒç”¨ SessionLocal() åˆ›å»ºä¼šè¯å¯¹è±¡
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# åˆ›å»ºæ‰€æœ‰æ¨¡å‹ç±»çš„åŸºç±»ï¼Œå…¶ä»–æ¨¡å‹éƒ½è¦ç»§æ‰¿å®ƒ
# Base.metadata.create_all(engine) å¯ç”¨æ¥è‡ªåŠ¨ç”Ÿæˆè¡¨
Base = declarative_base()
```

### `app/models.py`

```python
from sqlalchemy import Column, Integer, String, DateTime  # å®šä¹‰å­—æ®µç±»å‹
from datetime import datetime
from .database import Base  # ä» database.py å¼•å…¥ Base ç±»

# åˆ›å»ºä¸€ä¸ª User æ¨¡å‹ç±»ï¼Œå¯¹åº”æ•°æ®åº“ä¸­çš„ users è¡¨
class User(Base):
    __tablename__ = "users"  # æ•°æ®åº“ä¸­çš„è¡¨åæ˜¯ users

    # ä¸»é”®å­—æ®µï¼Œè‡ªåŠ¨é€’å¢
    id = Column(Integer, primary_key=True, index=True)

    # ç”¨æˆ·åå­—æ®µï¼Œå”¯ä¸€çº¦æŸ + ç´¢å¼•
    username = Column(String, unique=True, index=True)

    # å­˜å‚¨åŠ å¯†åçš„å¯†ç ï¼ˆbcrypt åŠ å¯†ï¼‰
    hashed_password = Column(String)

    # ç”¨æˆ·æ³¨å†Œæ—¶é—´ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰ UTC æ—¶é—´
    created_at = Column(DateTime, default=datetime.utcnow)
```

---

## 3ï¸âƒ£ JWT ä¸å¯†ç å·¥å…·

### `app/auth.py`

```python
# å¯†ç åŠ å¯†ä¸ JWT å·¥å…·æ¨¡å—

from passlib.context import CryptContext
from jose import JWTError, jwt
from datetime import datetime, timedelta

# åˆ›å»ºå¯†ç ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç”¨äºå¯¹å¯†ç è¿›è¡Œå“ˆå¸Œä¸éªŒè¯
# bcrypt æ˜¯ä¸€ç§å¸¸ç”¨çš„å®‰å…¨å“ˆå¸Œç®—æ³•
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# JWT é…ç½®é¡¹
# ç”¨äºåŠ å¯†ç­¾åçš„å¯†é’¥ï¼ˆåº”ä¿å¯†ï¼Œå»ºè®®é€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶è¯»å–ï¼‰
SECRET_KEY = "your_secret_key_here"  # âš ï¸ ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…æ›´æ¢
# åŠ å¯†ç®—æ³•ï¼Œè¿™é‡Œä½¿ç”¨ HMAC-SHA256
ALGORITHM = "HS256"
# Token æœ‰æ•ˆæœŸï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰
ACCESS_TOKEN_EXPIRE_MINUTES = 30


# âœ… éªŒè¯æ˜æ–‡å¯†ç æ˜¯å¦å’ŒåŠ å¯†åçš„ä¸€è‡´ï¼ˆç”¨äºç™»å½•ï¼‰
def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)


# âœ… å¯¹ç”¨æˆ·çš„æ˜æ–‡å¯†ç è¿›è¡Œå“ˆå¸ŒåŠ å¯†ï¼ˆç”¨äºæ³¨å†Œæ—¶å­˜å…¥æ•°æ®åº“ï¼‰
def hash_password(password: str) -> str:
    return pwd_context.hash(password)


# âœ… åˆ›å»ºè®¿é—®ä»¤ç‰Œï¼ˆJWTï¼‰
# å‚æ•° data æ˜¯ payloadï¼Œä¾‹å¦‚ {"sub": username}
# å‚æ•° expires_delta æ˜¯æœ‰æ•ˆæœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
def create_access_token(data: dict, expires_delta: timedelta = None) -> str:
    # åˆ›å»ºå‰¯æœ¬ä»¥é˜²ä¿®æ”¹åŸå§‹æ•°æ®
    to_encode = data.copy()
    # è®¡ç®—è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ä¸ºå½“å‰æ—¶é—´ + ACCESS_TOKEN_EXPIRE_MINUTES
    expire = datetime.utcnow() + (expires_delta or timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES))
    # åœ¨ payload ä¸­æ·»åŠ  exp å­—æ®µï¼ˆJWT æ ‡å‡†å­—æ®µï¼‰
    to_encode.update({"exp": expire})
    # ä½¿ç”¨å¯†é’¥å’Œç®—æ³•ç¼–ç ä¸º JWT å­—ç¬¦ä¸²
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt


# âœ… è§£ç  JWTï¼Œå¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§
# è¿”å›è§£ç åçš„ payloadï¼ˆå¦‚ {"sub": "user1", "exp": ...}ï¼‰
def decode_access_token(token: str) -> dict:
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload
    except JWTError:
        # å¦‚æœ token æ— æ•ˆã€è¿‡æœŸæˆ–ä¼ªé€ ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸
        raise ValueError("Token is invalid or expired")
```

---

## 4ï¸âƒ£ Pydantic æ¨¡å‹

### `app/schemas.py`

```python
from pydantic import BaseModel

class UserCreate(BaseModel):
    username: str
    password: str

class Token(BaseModel):
    access_token: str
    token_type: str
```

---

## 5ï¸âƒ£ ç”¨æˆ·æ³¨å†Œ & ç™»å½•æ¥å£

### `app/routes/user_routes.py`

```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from .. import models, schemas, auth, database

# åˆ›å»ºä¸€ä¸ªè·¯ç”±å™¨å¯¹è±¡ï¼Œç”¨äºæŒ‚è½½åˆ°ä¸»åº”ç”¨ä¸Š
router = APIRouter()

# å®šä¹‰ä¸€ä¸ªä¾èµ–å‡½æ•°ï¼Œç”¨äºè·å–æ•°æ®åº“ session
def get_db():
    db = database.SessionLocal()
    try:
        yield db  # è¿”å› db ç»™è¯·æ±‚ä½¿ç”¨
    finally:
        db.close()  # è¯·æ±‚ç»“æŸåå…³é—­æ•°æ®åº“è¿æ¥


@router.post("/register", response_model=schemas.Token)
def register(user: schemas.UserCreate, db: Session = Depends(get_db)):
    """
    ç”¨æˆ·æ³¨å†Œæ¥å£ï¼š
    1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    2. åŠ å¯†å¯†ç å¹¶ä¿å­˜åˆ°æ•°æ®åº“
    3. è¿”å› JWT Token
    """
    # æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²æœ‰è¯¥ç”¨æˆ·å
    existing = db.query(models.User).filter_by(username=user.username).first()
    if existing:
        raise HTTPException(status_code=400, detail="Username already exists")

    # å¯¹å¯†ç è¿›è¡Œå“ˆå¸ŒåŠ å¯†
    hashed = auth.hash_password(user.password)

    # åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å¯¹è±¡å¹¶æ·»åŠ åˆ°æ•°æ®åº“
    new_user = models.User(username=user.username, hashed_password=hashed)
    db.add(new_user)
    db.commit()          # æäº¤äº‹åŠ¡
    db.refresh(new_user) # åˆ·æ–°å¯¹è±¡ä»¥è·å–å…¶ ID ç­‰ä¿¡æ¯

    # åˆ›å»º JWT Tokenï¼Œpayload ä¸­åŒ…å«ç”¨æˆ·æ ‡è¯† "sub"
    token = auth.create_access_token(data={"sub": new_user.username})

    # è¿”å› token ç»™å®¢æˆ·ç«¯
    return {"access_token": token, "token_type": "bearer"}

@router.post("/login", response_model=schemas.Token)
def login(user: schemas.UserCreate, db: Session = Depends(get_db)):
    """
    ç”¨æˆ·ç™»å½•æ¥å£ï¼š
    1. æŸ¥æ‰¾ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    2. æ ¡éªŒå¯†ç æ˜¯å¦æ­£ç¡®
    3. è¿”å› JWT Token
    """
    # æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾æ•°æ®åº“ä¸­çš„ç”¨æˆ·è®°å½•
    db_user = db.query(models.User).filter_by(username=user.username).first()

    # ç”¨æˆ·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯
    if not db_user or not auth.verify_password(user.password, db_user.hashed_password):
        raise HTTPException(status_code=401, detail="Invalid credentials")

    # ç™»å½•æˆåŠŸï¼Œç”Ÿæˆ JWT Token
    token = auth.create_access_token(data={"sub": db_user.username})

    # è¿”å› token ç»™å®¢æˆ·ç«¯
    return {"access_token": token, "token_type": "bearer"}

```

---

## 6ï¸âƒ£ ä¸»ç¨‹åºå…¥å£

### `app/main.py`

```python
from fastapi import FastAPI
from .database import Base, engine
from .routes import user_routes

Base.metadata.create_all(bind=engine)

app = FastAPI()

app.include_router(user_routes.router)
```

---

## ğŸš€ å¯åŠ¨æœåŠ¡

```bash
uvicorn app.main:app --reload
```

è®¿é—®ï¼š
è¿›å…¥http://127.0.0.1:8000/docs
* `POST /register`
* `POST /login`
ç‚¹å‡» Try it out æŒ‰é’®
å¡«å†™è¯·æ±‚ä½“æ•°æ®
```
{
  "username": "user1",
  "password": "password123"
}
```


ä½ å°±å®Œæˆäº†åŸºç¡€çš„ç”¨æˆ·ç³»ç»Ÿå’Œ JWT é‰´æƒã€‚


